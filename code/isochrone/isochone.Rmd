---
title: "isochrone"
author: "Yuxuan"
date: "31/05/2021"
output:
  html_document: default
  pdf_document: default
---


## Import libraries
```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(ggplot2)
library(leaflet)
library(RColorBrewer)
library(scales)
library(lattice)
library(dplyr)
library(sf)
library(tidyverse)

# For pretty knitting
library(lemon)
knit_print.data.frame <- lemon_print
knit_print.tbl <- lemon_print
knit_print.summary <- lemon_print


```


### Import and organize data sets

```{R}


## Import raw Travel Time Matrix (ttm)
ttm <- read.csv('../../data/clean/ttm.csv')
df<-read_csv('../../data/score_sets/newest_long_scores.csv')
# convert Ids from double to factor
ttm$fromId <- as.factor(ttm$fromId)
ttm$toId <- as.factor(ttm$toId)

target_amenities <- c('gallery', 'museum', 'library or archives', 'theatre/performance and concert hall')
amenities <- read.csv('../../data/clean/vancouver_facilities_2.csv') %>% filter(type %in% target_amenities)
# clean
amenities <- amenities[,c(1,4)] # only need id and type columns
amenities$id <- as.factor(amenities$id)     # convert to factor
amenities$type <- as.factor(amenities$type) # convert to factor

# Import weight
dest_wts <- read.csv('../../data/amenity_weight/poi_index.csv')

ttm <- ttm %>% inner_join(amenities, by = c('toId' = 'id'))
head(ttm)
```

```{R}

### only consider the nearest amenity
nearest_1_ttm <- ttm %>%
                  group_by(fromId, type) %>%
                  summarise(avg_time = min(avg_unique_time), 
                            toId=toId[which.min(avg_unique_time)],
                            sd_time = sd_unique_time[which.min(avg_unique_time)])
nearest_1_ttm<-na.omit(nearest_1_ttm)
nearest_1_ttm%>%filter(type=='museum')%>%group_by(toId)%>%filter(avg_time<15)
```


#### Assign level to each group 
Group1: 0-15   
Group2: 15-30
Group3: 30-45
Group4: 45-60
```{R}
# check the histogram of avg time 
plot(hist(nearest_1_ttm$avg_time))
```

```{R}
# create a new column useing ifelse
# between function is inclusive <=
nearest_1_ttm$time_group= with(nearest_1_ttm, ifelse(avg_time<15,"<15",
                  ifelse(between(avg_time,15,29) , "15-30",
                         ifelse(between(avg_time,30,44),"30-45","45-60"))))


nearest_1_ttm$time_group<-as.factor(nearest_1_ttm$time_group)
nearest_1_ttm
```
```{R}
# nearest 1 export 

write_csv(nearest_1_ttm,"../../data/score_sets/nearest_1_ttm.csv")

```


````{R}



# Import shape file data
# keep necessary columns and rows for shp
canada_dbs <- st_read("../../code/Visualizations/census2016_DBS_shp/DB_Van_CMA/DB_Van_CMA.shp", stringsAsFactors = FALSE)
van_dbs <- data.frame(canada_dbs[which(canada_dbs$CMANAME == "Vancouver"), ])
van_dbs$ID <- seq.int(nrow(van_dbs))
clean_van_dbs <- van_dbs[, c(1, 28, 29)]
head(clean_van_dbs)
# join data into a single dataframe
# convert back to sf object
van_dbs_scores <- left_join(clean_van_dbs,nearest_1_ttm , by = c('DBUID' = 'fromId'))
van_dbs_scores_sf <- st_as_sf(van_dbs_scores)
van_dbs_scores_st <- st_transform(van_dbs_scores_sf,crs = 4326)
van_dbs_scores_st

```




```{R}



polyg_subset <- van_dbs_scores_st%>%filter(type=="museum")
score_vec <- polyg_subset$time_group

# colour palette

pal_fun <- colorFactor(
  palette = c("#e30606", "#fd8d3c", "#ffe669", "#cdff5e"),
  levels = unique(polyg_subset$time_group)
)


    
  # interactive popup
  p_popup <- paste0("<strong>Accessibility:</strong>", score_vec)
    
    # Add add-ons to maps
  

  
  leaflet(data =polyg_subset) %>%
    addPolygons(
      stroke = FALSE,  # remove polygon borders
      fillColor = ~pal_fun(time_group) , # set fill colour with pallette fxn from aboc
      fillOpacity = 0.4, smoothFactor = 0.2, # aesthetics
      popup = p_popup) %>% # add message popup to each block
    addTiles() %>%
      setView(lng = -122.8, lat = 49.2, zoom = 11) %>%
    addLegend("bottomleft",  # location
              pal=pal_fun,    # palette function
              values=~score_vec,  # value to be passed to palette function
              title = "Vancouver museum Transit Accessibility") # legend title



```


