---
title: "Many-to-Many Point Computation Script"
author: "Rain Shen"
output:
  pdf_document: default
  html_document:
    df_print: paged
---

### Loading libraries
```{r include=FALSE}

library(r5r)
library(rJava)
library(sf)
library(data.table)

library(tidyverse)
library(glue)
library(rlist)

```


### 1. Setup the Network Graph

- If the vancouver_canada.osm.pbf file needs to be converted to an .osm, one can use a binary osm converter available at: https://wiki.openstreetmap.org/wiki/Osmconvert#Binaries

```{r message=FALSE, warning=FALSE}
## Allocate 4G RAM to Java
options(java.parameters = "-Xmx4g")

## Build transport network, pointing to path where OSM and GTFS data are located
r5r_core <- setup_r5(data_path = getwd(), verbose = FALSE)
```


### 2. Load origin/destination points

```{r, warning=FALSE}

# Dissemination Blocks

origins <- read.csv("vancouver_db.csv")
paste('Origin Rows: ', nrow(origins))

origins <- origins[, c(1,3,4)]
colnames(origins)[1] <- 'id'
origins$id <- as.character(origins$id)  # numeric to char

head(origins)
```

```{r message=FALSE, warning=FALSE}
# Cultural/Art facilities
# destinations <- fread(file.path("../../data/clean", "vancouver_facilities_2.csv"))
destinations <- read.csv('vancouver_facilities_2.csv')
paste('Original Destinations: ', nrow(destinations))

# See summary counts of each amenity
destinations %>% group_by(type) %>% summarise(count = n()) %>% arrange(desc(count))

# Filter amenity types to keep amenities of interest**
target_amenities <- c('gallery', 'museum', 'library or archives', 'theatre/performance and concert hall')
destinations <- destinations %>% filter(type %in% target_amenities)

# Keep only id, lat, and lon columns
destinations <- destinations[, 1:3]

destinations$lat <-  as.numeric(destinations$lat) # char to numeric
destinations$lon <-  as.numeric(destinations$lon) # char to numeric
destinations$id <- as.character(destinations$id)  # numeric to char

# Remove null values
na.omit(destinations)->destinations

# destinations <- destinations[complete.cases(destinations)] # remove NA rows
paste('Filtered Destinations: ', nrow(destinations))

# Peek
head(destinations)

```

### 3. Set constraints

```{r}
# Non-transit : WALK, BICYCLE, CAR, BICYCLE_RENT, CAR_PARK
# Transit: TRAM, SUBWAY, RAIL, BUS, FERRY, CABLE_CAR, GONDOLA, FUNICULAR
mode <- c('WALK', 'TRANSIT')

max_walk_dist <- 1000 # 1 km

max_trip_duration <- 120 # 2 hours

max_rides <- 3 # max transfers

```


### 4. Compute Expanded Travel Time Matrix

- We average transit times across all weekly transit schedules so we compute travel time on:
  - A weekday
  - Saturday
  - Sunday
- We also want average transit times across time of day so we compute travel times from:
  - 7am to 7pm at every hour mark with a departure window of 30 minutes.
  - A window of 1 equates to a 5 minute departure window so we will use 6.


### Friday

```{r}
all_ttms5 <- list()
hour5 <- c()

for (time in 7:19) {        # 7 to 19 hours
    
  departure_datetime5 <- as.POSIXct(glue("14-05-2021 {time}:00:00"), format="%d-%m-%Y %H:%M:%S")
  
  ttm5 <- travel_time_matrix(r5r_core = r5r_core,
                            origins = origins,
                            destinations = destinations,
                            departure_datetime = departure_datetime5,
                            time_window = 30,
                          
                            # constrains
                            mode = mode,
                            max_walk_dist = max_walk_dist,
                            max_trip_duration = max_trip_duration,
                            max_rides = max_rides,
                            verbose = FALSE)
  
  hour5 <- append(hour5, nrow(ttm5))
    
  all_ttms5 <-  list.append(all_ttms5, ttm5) 
    
  
}

# Fast way to bind all data.frames
TTM5 <- rbindlist(all_ttms5)

print('COMPLETED')
```

```{r}
# For peak time

list1 <- 7:10
t1 <- c()
for (i in 1:length(hour5)) {
  
  t <- rep(list1[i], times = hour5[i])
  t1 <- append(t1, t)
}

t1 <- paste0("0", t1)

t2 <- mapply(function(x,y) paste0(rep(x,y), collapse = ""), 0, 4 - nchar(t1))
t1 <- paste0(t1, t2)

t1 <- format(strptime(t1, format="%H%M"), format = "%H:%M")

TTM5 <- cbind(t1, TTM5)
head(TTM5)
saveRDS(TTM5, file = "TTM5_PEAK.rds")
```


```{r}
# For 12 hour range (7am to 7pm)


list1 <- 7:19
t1 <- c()
for (i in 1:length(hour5)) {
  
  t <- rep(list1[i], times = hour5[i])
  t1 <- append(t1, t)
}

# t0 <- t1[1:sum(hour5[1:3])]
# 
# t0 <- paste0("0", t0)
# t1[1:sum(hour5[1:3])] <- t0

t2 <- mapply(function(x,y) paste0(rep(x,y), collapse = ""), 0, 4 - nchar(t1))
t1 <- paste0(t1, t2)

t1 <- format(strptime(t1, format="%H%M"), format = "%H:%M")

TTM5 <- cbind(t1, TTM5)
head(TTM5)
# saveRDS(TTM5, file = "TTM5_1013.rds")
```
```{r}
# Set the R_MAX_VSIZE to maximize the memory

usethis::edit_r_environ("project")
```

```{r}
# aggregate on each unique transit trip to compute the avg time
# time to the same destination

TTM5 <- readRDS("TTM5.rds")


TTM_agg <- TTM5 %>%
           group_by(t1, fromId, toId) %>% 
           summarise(
             avg_time = mean(travel_time)
           )
head(TTM_agg)
```

```{r}
# Export for later manipulation
write.csv(TTM_agg, "ttm5_1719.csv", row.names = FALSE)

```

```{r}
ttm_716 <- read.csv("ttm5_716.csv")
```

```{r}
ttm_719 <- rbind(ttm_716, TTM_agg)
write.csv(ttm_719, "ttm5_719.csv", row.names = FALSE)
```


### Saturday

```{r}
all_ttms6 <- list()
hour6 <- c()

for (time in 7:19) {        # 7 to 19 hours
    
  departure_datetime6 <- as.POSIXct(glue("15-05-2021 {time}:00:00"), format="%d-%m-%Y %H:%M:%S")
  
  ttm6 <- travel_time_matrix(r5r_core = r5r_core,
                            origins = origins,
                            destinations = destinations,
                            departure_datetime = departure_datetime6,
                            time_window = 30,
                          
                            # constrains
                            mode = mode,
                            max_walk_dist = max_walk_dist,
                            max_trip_duration = max_trip_duration,
                            max_rides = max_rides,
                            verbose = FALSE)
  
  hour6 <- append(hour6, nrow(ttm6))
    
  all_ttms6 <-  list.append(all_ttms6, ttm6) 
    
  
}

# Fast way to bind all data.frames
TTM6 <- rbindlist(all_ttms6)

print('COMPLETED')
```

```{r}
# For peak time range (7am to 10am)


list1 <- 7:10
t1 <- c()
for (i in 1:length(hour6)) {
  
  t <- rep(list1[i], times = hour6[i])
  t1 <- append(t1, t)
}

t1 <- paste0("0", t1)

t2 <- mapply(function(x,y) paste0(rep(x,y), collapse = ""), 0, 4 - nchar(t1))
t1 <- paste0(t1, t2)

t1 <- format(strptime(t1, format="%H%M"), format = "%H:%M")

TTM6 <- cbind(t1, TTM6)
head(TTM6)
saveRDS(TTM6, file = "TTM6_PEAK.rds")
```


```{r}
# For the 12 hour range (7am to 7pm)

list1 <- 7:19
t1 <- c()
for (i in 1:length(hour6)) {
  
  t <- rep(list1[i], times = hour6[i])
  t1 <- append(t1, t)
}

t0 <- t1[1:sum(hour6[1:3])]

t0 <- paste0("0", t0)
t1[1:sum(hour6[1:3])] <- t0

t2 <- mapply(function(x,y) paste0(rep(x,y), collapse = ""), 0, 4 - nchar(t1))
t1 <- paste0(t1, t2)

t1 <- format(strptime(t1, format="%H%M"), format = "%H:%M")

TTM6 <- cbind(t1, TTM6)
head(TTM6)
saveRDS(TTM6, file = "TTM6.rds")
```


### Sunday

```{r}
all_ttms7 <- list()
hour7 <- c()

for (time in 7:19) {        # 7 to 19 hours
    
  departure_datetime7 <- as.POSIXct(glue("16-05-2021 {time}:00:00"), format="%d-%m-%Y %H:%M:%S")
  
  ttm7 <- travel_time_matrix(r5r_core = r5r_core,
                            origins = origins,
                            destinations = destinations,
                            departure_datetime = departure_datetime7,
                            time_window = 30,
                          
                            # constrains
                            mode = mode,
                            max_walk_dist = max_walk_dist,
                            max_trip_duration = max_trip_duration,
                            max_rides = max_rides,
                            verbose = FALSE)
  
  hour7 <- append(hour7, nrow(ttm7))
    
  all_ttms7 <-  list.append(all_ttms7, ttm7) 
    
  
}

# Fast way to bind all data.frames
TTM7 <- rbindlist(all_ttms7)

print('COMPLETED')
```

```{r}
# For peak time range (7am to 10am)


list1 <- 7:10
t1 <- c()
for (i in 1:length(hour7)) {
  
  t <- rep(list1[i], times = hour7[i])
  t1 <- append(t1, t)
}

t1 <- paste0("0", t1)

t2 <- mapply(function(x,y) paste0(rep(x,y), collapse = ""), 0, 4 - nchar(t1))
t1 <- paste0(t1, t2)

t1 <- format(strptime(t1, format="%H%M"), format = "%H:%M")

TTM7 <- cbind(t1, TTM7)
head(TTM7)
saveRDS(TTM7, file = "TTM7_PEAK.rds")
```


```{r}
# For the 12 hour range (7am to 7pm)

list1 <- 7:19
t1 <- c()
for (i in 1:length(hour7)) {
  
  t <- rep(list1[i], times = hour7[i])
  t1 <- append(t1, t)
}

t0 <- t1[1:sum(hour7[1:3])]

t0 <- paste0("0", t0)
t1[1:sum(hour7[1:3])] <- t0

t2 <- mapply(function(x,y) paste0(rep(x,y), collapse = ""), 0, 4 - nchar(t1))
t1 <- paste0(t1, t2)

t1 <- format(strptime(t1, format="%H%M"), format = "%H:%M")

TTM7 <- cbind(t1, TTM7)
head(TTM7)
saveRDS(TTM7, file = "TTM7.rds")
```

