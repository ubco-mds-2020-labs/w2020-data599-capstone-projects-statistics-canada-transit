---
title: "Outlier Point Exploration"
author: "Luka Vukovic"
output:
  html_document:
    df_print: paged
  pdf_document: default
---

### Loading libraries
```{r include=FALSE}

# Main
library(r5r)
#if (Sys.getenv("JAVA_HOME")!="")
#  Sys.setenv(JAVA_HOME="")
library(rJava)
library(sf)
library(data.table)

# Visualization
library(ggplot2)
library(mapview); mapviewOptions(platform = 'leafgl')

# Convenience
library(tidyverse)
library(glue)
library(rlist)

```


### 1. Setup the Network Graph

- If the vancouver_canada.osm.pbf file needs to be converted to an .osm, one can use a binary osm converter available at: https://wiki.openstreetmap.org/wiki/Osmconvert#Binaries

```{r message=FALSE, warning=FALSE}
## Allocate 4G RAM to Java
options(java.parameters = "-Xmx6g")

## Build transport network, pointing to path where OSM and GTFS data are located
r5r_core <- setup_r5(data_path = getwd(), verbose = FALSE)
```


### 2. Load origin/destination points

```{r, warning=FALSE}

# Dissemination Blocks
origins <- fread(file.path("../../data/clean", "vancouver_db.csv"))
origins <- origins[, c(1,3,4)]
colnames(origins)[1] <- 'id'
origins$id <- as.character(origins$id)  # numeric to char

# Cultural/Art facilities
destinations <- fread(file.path("../../data/clean", "vancouver_facilities_2.csv"))
destinations <- destinations[, 1:3]

destinations$lat <-  as.numeric(destinations$lat) # char to numeric
destinations$lon <-  as.numeric(destinations$lon) # char to numeric
destinations$id <- as.character(destinations$id)  # numeric to char

destinations <- destinations[complete.cases(destinations)] # remove NA rows

# Peek
head(origins)
head(destinations)

# Check
c(nrow(origins), nrow(unique(origins[,1])))
c(nrow(destinations), nrow(unique(destinations[,1])))
```

### 3. Keep only outlier dissemination blocks based on previously computed scores
```{r}
## Scores
all_destination_scores <- read.csv('../../data/score_sets/all_destination_scores.csv')

## Outlier scores manually copied from visualization maps
outs <- c(0.11349337693329, # downtown public library
          0.234389061728555,# residential block near Prince Charles Elementary
          0.0181898367959507) # loutet park

outs_amenities <- all_destination_scores[all_destination_scores$score %in% outs, 1]

## Testing samples
sample_origins <- origins[origins$id %in% outs_amenities, ]

sample_origins

# 59150178010 = loutet park
# 59152188005 = residential block near Prince Charles Elementary
# 59153780003 = middle of a lake near little cambell river
# 59154027001 = library

```


### 4. Set constraints

```{r}
# Non-transit : WALK, BICYCLE, CAR, BICYCLE_RENT, CAR_PARK
# Transit: TRAM, SUBWAY, RAIL, BUS, FERRY, CABLE_CAR, GONDOLA, FUNICULAR
mode <- c('WALK', 'TRANSIT')

max_walk_dist <- 1000 # 1 km

max_trip_duration <- 120 # 2 hours

max_rides <- 3 # max transfers

```


### 5. Compute Expanded Travel Time Matrix

- We average transit times across all weekly transit schedules so we compute travel time on:
  - A weekday
  - Saturday
  - Sunday
- We also want average transit times across time of day so we compute travel times from:
  - 7am to 7pm at every hour mark with a departure window of 30 minutes.
  - A window of 1 equates to a 5 minute departure window so we will use 6.

```{r}
# default walk speed = 3.6 km/h

all_ttms <- list()

for (day in 14:16) {          # May 14=Fri, 15=Sat, 16=Sun
  for (time in 7:19) {        # 7 to 19 hours
    
    departure_datetime <- as.POSIXct(glue("{day}-05-2021 {time}:00:00"), format="%d-%m-%Y %H:%M:%S")
    
    ttm <- travel_time_matrix(r5r_core = r5r_core,
                          origins = sample_origins,
                          destinations = destinations,
                          departure_datetime = departure_datetime,
                          time_window = 30,
                          
                          # constrains
                          mode = mode,
                          max_walk_dist = max_walk_dist,
                          max_trip_duration = max_trip_duration,
                          max_rides = max_rides,
                          verbose = FALSE)
    
    all_ttms <-  list.append(all_ttms, ttm) # very slow: rbind(all_ttm, ttm)
    
    print(glue('Progress: {round(((day-14)*12 + time-6)/37*100, 1)}%'))
  }
}

# Fast way to bind all data.frames
TTM <- rbindlist(all_ttms)

print('COMPLETED')

summary(TTM)
```


### 6. Inspect
```{r}
avg_ttm <- TTM %>% group_by(fromId, toId) %>% summarise(avg_tt = mean(travel_time))

avg_ttm %>% group_by(fromId) %>% summarise(destinations = n())

# 59150178010 = abnormally low
# 59152188005 = normal value
# 59153780003 = abnormally low
# 59154027001 = abnormally low
```

```{r}
# Reindex to keep abnormal values
sample_origins2 <- sample_origins[c(1,3,4),]
sample_origins2
```

### 7. Compute detialed itineraries
```{r}
set.seed(78)

# 123 = Walnut grove community centre / pool


departure_datetime <- as.POSIXct(glue("15-05-2021 11:00:00"), format="%d-%m-%Y %H:%M:%S") # saturday may 15th @ 11am

sample_destination <- sample_n(destinations, 1) 
sample_destination

loutet <- detailed_itineraries(r5r_core = r5r_core,
                            origins = sample_origins2[1],
                            destinations = sample_destination,
                          
                            # constrains
                            mode = mode,
                            max_walk_dist = max_walk_dist,
                            max_trip_duration = max_trip_duration,
                            max_rides = max_rides,
                            verbose = FALSE)

resblck <- detailed_itineraries(r5r_core = r5r_core,
                            origins = sample_origins2[2],
                            destinations = sample_destination,
                          
                            # constrains
                            mode = mode,
                            max_walk_dist = max_walk_dist,
                            max_trip_duration = max_trip_duration,
                            max_rides = max_rides,
                            verbose = FALSE)

library <- detailed_itineraries(r5r_core = r5r_core,
                            origins = sample_origins2[3],
                            destinations = sample_destination,
                          
                            # constrains
                            mode = mode,
                            max_walk_dist = max_walk_dist,
                            max_trip_duration = max_trip_duration,
                            max_rides = max_rides,
                            verbose = FALSE)

all_trips <- c(loutet, resblck, library)
all_trips
```

```{r}
# extract OSM network
street_net <- street_network_to_sf(r5r_core)

```


```{r}

# 115 = vancouver public library (same block)
# 2359 = central branch library archives (same block)
# 7212 = outreach services library or archives (same block)

# 115, 2359, 7212 == possible destinations retrieved from r5r ttm computation
destinations[destinations$id == 115, ]
destinations[destinations$id == 2359, ]
destinations[destinations$id == 7212, ]


library <- detailed_itineraries(r5r_core = r5r_core,
                            origins = sample_origins2[3],
                            destinations = destinations[destinations$id == 115, ], 
                          
                            # constrains
                            mode = mode,
                            max_walk_dist = max_walk_dist,
                            max_trip_duration = max_trip_duration,
                            max_rides = max_rides,
                            verbose = FALSE)
mapview(library)

library <- detailed_itineraries(r5r_core = r5r_core,
                            origins = sample_origins2[3],
                            destinations = destinations[destinations$id == 2359, ], # 115, 2359, 7212 == possible destinations
                          
                            # constrains
                            mode = mode,
                            max_walk_dist = max_walk_dist,
                            max_trip_duration = max_trip_duration,
                            max_rides = max_rides,
                            verbose = FALSE)
mapview(library)

library <- detailed_itineraries(r5r_core = r5r_core,
                            origins = sample_origins2[3],
                            destinations = destinations[destinations$id == 7212, ], # 115, 2359, 7212 == possible destinations
                          
                            # constrains
                            mode = mode,
                            max_walk_dist = max_walk_dist,
                            max_trip_duration = max_trip_duration,
                            max_rides = max_rides,
                            verbose = FALSE)
mapview(library)

```

### What if we slightly modify the starting coordinates?
```{r}

new_lib_start_coords <- sample_origins[4]
new_lib_start_coords$lat <- 49.279471
new_lib_start_coords$lon <- -123.116750


all_ttms <- list()

for (day in 14:16) {          # May 14=Fri, 15=Sat, 16=Sun
  for (time in 7:19) {        # 7 to 19 hours
    
    departure_datetime <- as.POSIXct(glue("{day}-05-2021 {time}:00:00"), format="%d-%m-%Y %H:%M:%S")
    
    ttm <- travel_time_matrix(r5r_core = r5r_core,
                          origins = new_lib_start_coords,
                          destinations = destinations,
                          departure_datetime = departure_datetime,
                          time_window = 30,
                          
                          # constrains
                          mode = mode,
                          max_walk_dist = max_walk_dist,
                          max_trip_duration = max_trip_duration,
                          max_rides = max_rides,
                          verbose = FALSE)
    
    all_ttms <-  list.append(all_ttms, ttm) # very slow: rbind(all_ttm, ttm)
    
    print(glue('Progress: {round(((day-14)*12 + time-6)/37*100, 1)}%'))
  }
}

# Fast way to bind all data.frames
TTM <- rbindlist(all_ttms)

print('COMPLETED')


avg_ttm <- TTM %>% group_by(fromId, toId) %>% summarise(avg_tt = mean(travel_time))

avg_ttm %>% group_by(fromId) %>% summarise(destinations = n())
```

```{r}
new_lib_start_coords

sample_destination <- sample_n(destinations, 1) 
sample_destination

library_new_ <- detailed_itineraries(r5r_core = r5r_core,
                            origins = new_lib_start_coords,
                            destinations = destinations,
                          
                            # constraints
                            mode = mode,
                            max_walk_dist = max_walk_dist,
                            max_trip_duration = max_trip_duration,
                            max_rides = max_rides,
                            verbose = FALSE)

```

```{r}
ggplot() +
  geom_sf(data = street_net$edges, color='gray85') +
  geom_sf(data = library_new_, aes(color=mode)) +
  facet_wrap(.~option) + 
  theme_void()
```


```{r}
mapView(library_new_)
```









